#!/bin/bash

set -euo pipefail

CZBI_VERSION='1.0'
CZBI_BIN="$HOME/.local/bin"
CZBI_HOME="${XDG_DATA_HOME:-"$HOME/.local/share"}/czbi"

print_usage() {
    echo "czbi $CZBI_VERSION"
    echo ''
    echo 'USAGE: czbi REPO'
    echo '       czbi home'
    echo '       czbi uninstall EXE'
    echo ''
    echo 'czbi is a script for installing Zig-built executables. To customize it, edit'
    echo 'the script or fork the repository for yourself.'
    echo ''
    echo 'See https://github.com/booniepepper/czbi for discussion, wiki, issues, or to'
    echo 'fork the project for your own needs.'
    echo ''
    echo 'czbi REPO'
    echo '    Clone, zig build, and install whatever is produced by REPO. The clone'
    echo '    and zig build happens in a directory prefixed by $XDG_DATA_HOME/czbi/$REPO'
    echo '    or if XDG_DATA_HOME is unset/empty then $HOME/.local/share/czbi/$REPO'
    echo ''
    echo '    If REPO is in the format name/project then it will be expanded as a github'
    echo '    https url like https://github.com/name/project -- Other formats are passed'
    echo '    to git clone directly.'
    echo ''
    echo '    If the REPO is already cloned, instead of a git clone, a git pull will be'
    echo '    performed.'
    echo ''
    echo '    The build performed will simply be "zig build" with no other arguments.'
    echo ''
    echo '    After a build, czbi will produce symbolic links in $HOME/.local/bin for any'
    echo '    binaries found in a project-local zig-out/bin/ directory.'
    echo ''
    echo '    Any conflicts are replaced with a warning.'
    echo ''
    echo 'czbi home'
    echo '    Prints the directory czbi will use for cloning repositories.'
    echo ''
    echo 'czbi uninstall EXE'
    echo '    Uninstall EXE by deleting a symlink at $HOME/.local/bin/$EXE'
}

case "$1" in
    help|--help|-h) print_usage
                    exit 0
                    ;;

    home)           echo "$CZBI_HOME"
                    exit 0
                    ;;

    version|--version|-V)
                    echo "$CZBI_VERSION"
                    exit 0
                    ;;

    uninstall)      set -x
                    rm "$CZBI_BIN/$2"
                    exit 0
                    ;;
esac

# Ok we're installing!

set -x

REPO="$1"


# ===  Clone  === #


mkdir -p "$CZBI_HOME"
cd "$CZBI_HOME" || exit 1

if [[ $REPO =~ ^[A-Za-z0-9_-]+/[A-Za-z0-9_-]+$ ]]
then
    REPO_URL="https://github.com/$REPO.git"
else
    REPO_URL="$REPO"
    REPO="$(echo "$REPO" | sed -E 's/^\s*.*:\/\///' | sed -E 's/\.git$//')"
fi

echo "REPO:       $REPO"
echo "REPO_URL:   $REPO_URL"

if [[ -d $REPO ]]
then
    cd "$REPO" || exit 1
    git pull
else
    git clone "$REPO_URL" "$REPO"
    cd "$REPO" || exit 1
fi


# ===  Zig build  === #


zig version

zig build


# ===  Install  === #


for exe in $(find zig-out/bin -type f)
do
    existing="$CZBI_BIN/$(basename "$exe")"
    if [[ -f $existing ]]
    then
        rm "$existing"
    fi

    ln -s "$PWD/$exe" "$CZBI_BIN/"
done

